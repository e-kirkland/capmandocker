# CAPMAN - CapManagement Solution for Sleeper Fantasy Football Leagues
Sleeper is a fantastic application for managing fantasy football leagues, especially dynasty and keeper leagues. However, it does not allow for monitoring long-term salary cap, keeping up with player salary adjustments year over year and ensuring every team abides by the league cap. CAPMAN is an integrated solution which reads from Sleeper's API and maintains a database of salary info for each team. The system automatically tracks roster transactions (waiver, free-agent, trades, etc.) and allows users to view their roster/cap status via a simple web dashboard or Slack integration.

---

## League setup
To begin customizing CAPMAN for your league, adjust the `src/project/media/league_users.json` file. This file contains several key pieces of adjustable information:
* `"league_id"`: Your Sleeper league id.
* `"rosters"`: Each team's information. Including:
  * Slack UserID as JSON key
    * `"roster_id"`: Numeric value of the user's roster as set in database
    * `"url"`: Url where CAPMAN is deployed.
* `"lookupdict"`: Lookup dictionary with text which can be used to query rosters/cap from Slack's capman channel.
  * Roster_id as JSON key
    * Array of words to detect in slack message
* `"scoring"`: Dictionary of scoring multipliers, used to compute WAR

---

## Fly.io deployment

Capman is currently hosted via fly.io at [https://capman.dev.fly](https://capman.dev.fly), but can be hosted in any environment using the Docker image found in the `src` directory.

### Adjustments for fly deployment
Several files need to be edited in order to successfully deploy to fly.io:
* `.env` - This file needs to be added in the `web` directory. See the `.env.sample` file for a reference, inserting your keys and information as needed.
* Several envionrment variables need to be set to match your postgres instance:
  * `DATABASE_URL`
  * `SQL_HOST`
  * `SQL_PORT`
* `fly.toml` - This file is autogenerated by fly.io, and may interfere with a new deployment. Delete this file and rebuild using:
</ul>

    cd web
    flyctl launch

### Fly.io: Deploy

To deploy:

    cd web
    flyctl deploy

### Fly.io: View Database

To activate psql shell:
    flyctl postgres connect -a capman-db
    \c capman

### Fly.io: SSH Access

To access shell:
    flyctl ssh console

---

## Web Interface
The CAPMAN web interface is a simple plotly DASH application which shows current league cap information, player WAR/value, roster statuses, and allows for the dynamic updating of any player records in the database. It is broken into several key pages:
* Dashboard - A quick view of the league cap/roster status and settings
* Rosters - A way to view each team's roster using the provided dropdown
* TradeView - A side-by-side comparison of two teams
* All Players - A readout of all player data in the database. This table is editable, and any changes made can be persisted to the database by clicking "Save Changes." NOTE - these changes are destructive and cannot be undone.

*Note: The current CAPMAN web interface is only optimized for desktop viewing*

### Upload Endpoint
You can also upload files to the `src/project/media/` directory by visiting the web endpoint: `http://<yourdeploymenturl>/upload`

---

## Slack Integration

Capman is intended to be used with Slack, and a user-created slack bot.

### Slack Setup

To create an integrate a Capman Slack Bot: 

1. Create a slack channel in your slack application named `capman` for user interaction and messaging.
2. Create a slack channel in your slack application named `cap-alerts` for automated cap-related alerts.
3. Edit the json manifest in the `slack_manifest.json` file to point to your current deployment url endpoints and slack channels.
4. Visit the [slack api](https://https://api.slack.com/apps) page and create a new app. Select the option which allows you to create "From an app manifest," and input the edited json.
5. Invite your bot to the `capman` and `cap-alerts` channel.

### Slack Usage

Capman can be accessed via slack in a variety of ways.

#### Slash Commands
These slash commands can be executed in the `capman` slack channel, and will allow the user to read from or interact with the capman database.

* `/initialize {league_id} {salaryCap} {rosterMin} {rosterMax}`
  * This command will set up your league. Include the appropriate variables after the `initialize` command to set up the league settings appropriately.
  * E.g. `/initialize 123456789 200 20 28`
* `/settings {salary_cap} {rosterMin} {rosterMax}`
  * This command will alter your league settings.
  * E.g. `/settings 300 1 29`
* `/salary-reset`
  * This command starts the process of resetting league data.
  * After submitting the command, a .csv file will be made available for download with all data from the `players` table.
  * Use this file to edit any player salary, roster, or other information.
  * When you are finished editing, export the file as a .csv and post it in the `capman` channel.
  * CAPMAN will read the file and use it to update its internal database accordingly.
* `/roster`
  * This command will display your current roster.
  * It can also be combined with search terms set up in the `league_users.json` configuration file. This way you can search for other rosters by adding keywords (e.g. `/roster john`)
* `/cap`
  * This command will display a quick update of your current cap status.
  * It can also be combined with search terms set up in the `league_users.json` configuration file.

#### Compliance Alerts
CAPMAN will regularly check all rosters to make sure all teams are compliant with the salary cap, league minimum and league maximum. If players are out of compliance, alerts will be posted in the `cap-alerts` slack channel. It is a good idea to turn on notifications for this channel.

---

## API Endpoints
CAPMAN works primarily through RESTFUL API endpoints, with several important endpoints for managing a league:

### Setup League

Initialize league and prepare for data input/adjustments.

**URL** : `/api/setupLeague`

**METHOD** : `POST`

**ARGS** : `leagueID`, `salaryCap`, `rosterMin`, `rosterMax`

### Check Transactions

Read historical transactions and update if any new transactions exist.

**URL** : `/api/checkTransactions`

**METHOD** : `GET`

**ARGS** : `leagueID`

### Check Compliance

Check league compliance and alert via slack channel if teams are over/under parameters.

**URL** : `/api/checkCompliance`

**METHOD** : `GET`

### Get WAR

Calculate WAR (Wins Against Replacement) for all players in league.

**URL** : `/api/getWAR`

**METHOD** : `GET`

### Get Roster

Read roster by roster_id

**URL** : `/players/<roster_id>`

**METHOD** : `GET`

### Update Roster

Update roster by roster_id

**URL** : `/players/<roster_id>`

**METHOD** : `PUT`

**DATA CONSTAINTS** :

    {
        "players": [
            {
                "_id": null,
                "injured_reserve": false,
                "player": "Hunter Henry",
                "player_id": "3214",
                "position": "TE",
                "roster_id": 1,
                "salary": "0",
                "team": "NE",
                "value": 0.0,
                "war": 0.0
            },...
    }

### Get Settings

Read settings by league_id

**URL** : `/settings/<league_id>`

**METHOD** : `GET`

### Update Settings

Update settings by league_id

**URL** : `/settings/<league_id>`

**METHOD** : `PUT`

**DATA CONSTAINTS** :

    {
        "message": "Successfully updated settings with league_id: 786278549685440512",
        "result": {
            "_id": "ef830af6-fe01-4f50-8318-6a40d52c7bef",
            "league_id": "786278549685440512",
            "roster_max": 24,
            "roster_min": 20,
            "salary_cap": 300,
            "transaction_id": "885921790176714752"
        },
        "success": true
    }

